<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Liquid Wave WebAR</title>
    <meta name="description" content="WebAR Liquid Wave Effect with Hand Tracking">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/aframe/1.4.0/aframe.min.js"></script>
    <script src="//cdn.8thwall.com/web/aframe/8frame-1.4.0.min.js"></script>
    <script src="//cdn.8thwall.com/web/xrextras/xrextras.js"></script>
    <script>
        // Wait for A-Frame to load before registering components
        window.addEventListener('DOMContentLoaded', function() {
            if (typeof AFRAME === 'undefined') {
                console.log('Waiting for A-Frame to load...');
                setTimeout(initComponents, 100);
            } else {
                initComponents();
            }
        });

        function initComponents() {
            if (typeof AFRAME === 'undefined') {
                console.log('A-Frame still loading, retrying...');
                setTimeout(initComponents, 100);
                return;
            }

            console.log('A-Frame loaded, registering components...');
            registerComponents();
        }

        function registerComponents() {
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
        }
        
        #instructions {
            position: fixed;
            top: 20px;
            left: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px;
            border-radius: 10px;
            z-index: 1000;
            text-align: center;
            font-size: 14px;
        }
        
        #status {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 10px;
            border-radius: 5px;
            z-index: 1000;
            text-align: center;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div id="instructions">
        <strong>Liquid Wave WebAR</strong><br>
        Pinch your thumb and index finger together to create magical liquid waves!<br>
        Release to solidify the wave in place.
    </div>
    
    <div id="status">
        Initializing hand tracking...
    </div>

    <a-scene 
        xrweb="disableWorldTracking: false"
        xrextras-gesture-detector
        xrextras-almost-there
        xrextras-runtime-error
        xrextras-loading
        renderer="colorManagement: true; physicallyCorrectLights: true;"
        vr-mode-ui="enabled: false"
        device-orientation-permission-ui="enabled: false"
        background="color: #000000">

        <!-- Assets -->
        <a-assets>
            <!-- Vertex shader for liquid wave effect -->
            <a-mixin id="liquid-material" 
                material="shader: standard; 
                         transparent: true; 
                         opacity: 0.7; 
                         color: #ff00ff; 
                         metalness: 0.1; 
                         roughness: 0.3;
                         emissive: #440044;
                         emissiveIntensity: 0.3;">
            </a-mixin>
        </a-assets>

        <!-- Lighting -->
        <a-light type="ambient" color="#404040" intensity="0.4"></a-light>
        <a-light type="directional" position="2 4 5" color="#ffffff" intensity="0.8"></a-light>
        <a-light type="point" position="0 2 0" color="#ff44ff" intensity="0.5"></a-light>

        <!-- Camera with hand tracking -->
        <a-camera 
            id="camera"
            position="0 1.6 0"
            look-controls="enabled: false"
            wasd-controls="enabled: false">
        </a-camera>

        <!-- Hand entities (will be populated by 8th Wall) -->
        <a-entity id="leftHand"></a-entity>
        <a-entity id="rightHand"></a-entity>

        <!-- Wave container -->
        <a-entity id="waveContainer"></a-entity>
    </a-scene>

            // Liquid wave component
            AFRAME.registerComponent('liquid-wave', {
            schema: {
                amplitude: {type: 'number', default: 0.1},
                frequency: {type: 'number', default: 2.0},
                speed: {type: 'number', default: 1.0},
                segments: {type: 'number', default: 32}
            },

            init: function() {
                this.time = 0;
                this.originalPositions = [];
                this.createWaveGeometry();
            },

            createWaveGeometry: function() {
                const segments = this.data.segments;
                const geometry = new THREE.SphereGeometry(0.15, segments, segments/2);
                
                // Store original positions
                const positions = geometry.attributes.position.array;
                for (let i = 0; i < positions.length; i += 3) {
                    this.originalPositions.push({
                        x: positions[i],
                        y: positions[i + 1],
                        z: positions[i + 2]
                    });
                }

                const material = new THREE.MeshStandardMaterial({
                    color: 0xff00ff,
                    transparent: true,
                    opacity: 0.6,
                    metalness: 0.1,
                    roughness: 0.3,
                    emissive: 0x440044,
                    emissiveIntensity: 0.3,
                    side: THREE.DoubleSide
                });

                this.mesh = new THREE.Mesh(geometry, material);
                this.el.setObject3D('mesh', this.mesh);
            },

            tick: function(time, timeDelta) {
                if (!this.mesh || !this.data.speed) return;

                this.time += timeDelta * 0.001 * this.data.speed;
                
                const positions = this.mesh.geometry.attributes.position.array;
                
                for (let i = 0; i < this.originalPositions.length; i++) {
                    const original = this.originalPositions[i];
                    const index = i * 3;
                    
                    // Create flowing wave effect
                    const wave1 = Math.sin(this.time * this.data.frequency + original.x * 5) * this.data.amplitude;
                    const wave2 = Math.cos(this.time * this.data.frequency * 1.3 + original.y * 3) * this.data.amplitude * 0.7;
                    const wave3 = Math.sin(this.time * this.data.frequency * 0.8 + original.z * 4) * this.data.amplitude * 0.5;
                    
                    positions[index] = original.x + wave1;
                    positions[index + 1] = original.y + wave2;
                    positions[index + 2] = original.z + wave3;
                }
                
                this.mesh.geometry.attributes.position.needsUpdate = true;
            },

            solidify: function() {
                // Stop animation and make more opaque
                this.data.speed = 0;
                this.mesh.material.opacity = 0.8;
                this.mesh.material.emissiveIntensity = 0.1;
            }
                    });
        }
        AFRAME.registerComponent('pinch-detector', {
            init: function() {
                this.leftPinching = false;
                this.rightPinching = false;
                this.leftWave = null;
                this.rightWave = null;
                this.waveCounter = 0;
                
                // Get elements safely
                this.waveContainer = document.getElementById('waveContainer');
            },

            tick: function() {
                const leftHand = document.getElementById('leftHand');
                const rightHand = document.getElementById('rightHand');
                
                if (leftHand && leftHand.components['xrextras-hand-model']) {
                    this.checkPinch('left', leftHand);
                }
                
                if (rightHand && rightHand.components['xrextras-hand-model']) {
                    this.checkPinch('right', rightHand);
                }
            },

            checkPinch: function(hand, handEl) {
                const handComponent = handEl.components['xrextras-hand-model'];
                if (!handComponent || !handComponent.data.handData) return;

                const handData = handComponent.data.handData;
                const isPinching = this.detectPinch(handData);
                const currentlyPinching = hand === 'left' ? this.leftPinching : this.rightPinching;
                
                if (isPinching && !currentlyPinching) {
                    // Start pinch - create wave
                    this.startPinch(hand, handEl);
                } else if (!isPinching && currentlyPinching) {
                    // End pinch - solidify wave
                    this.endPinch(hand);
                }
                
                if (hand === 'left') {
                    this.leftPinching = isPinching;
                } else {
                    this.rightPinching = isPinching;
                }
                
                // Update wave position during pinch
                if (isPinching) {
                    this.updateWavePosition(hand, handEl);
                }
            },

            detectPinch: function(handData) {
                if (!handData.landmarks || handData.landmarks.length < 21) return false;
                
                // Get thumb tip (4) and index tip (8) positions
                const thumbTip = handData.landmarks[4];
                const indexTip = handData.landmarks[8];
                
                if (!thumbTip || !indexTip) return false;
                
                // Calculate distance between thumb and index tips
                const distance = Math.sqrt(
                    Math.pow(thumbTip.x - indexTip.x, 2) +
                    Math.pow(thumbTip.y - indexTip.y, 2) +
                    Math.pow(thumbTip.z - indexTip.z, 2)
                );
                
                return distance < 0.05; // Threshold for pinch detection
            },

            startPinch: function(hand, handEl) {
                const status = document.getElementById('status');
                if (status) {
                    status.textContent = `${hand.charAt(0).toUpperCase() + hand.slice(1)} hand pinching - Creating liquid wave!`;
                }
                
                // Create new wave entity
                const waveEl = document.createElement('a-entity');
                waveEl.setAttribute('id', `wave-${hand}-${this.waveCounter++}`);
                waveEl.setAttribute('liquid-wave', 'amplitude: 0.08; frequency: 3; speed: 2');
                
                // Position wave at pinch point
                this.updateWavePosition(hand, handEl, waveEl);
                
                this.waveContainer.appendChild(waveEl);
                
                if (hand === 'left') {
                    this.leftWave = waveEl;
                } else {
                    this.rightWave = waveEl;
                }
            },

            endPinch: function(hand) {
                const status = document.getElementById('status');
                if (status) {
                    status.textContent = `${hand.charAt(0).toUpperCase() + hand.slice(1)} hand released - Wave solidified!`;
                }
                
                const wave = hand === 'left' ? this.leftWave : this.rightWave;
                if (wave && wave.components['liquid-wave']) {
                    wave.components['liquid-wave'].solidify();
                }
                
                if (hand === 'left') {
                    this.leftWave = null;
                } else {
                    this.rightWave = null;
                }
                
                setTimeout(() => {
                    const status = document.getElementById('status');
                    if (status) {
                        status.textContent = 'Pinch to create liquid waves!';
                    }
                }, 2000);
            },

            updateWavePosition: function(hand, handEl, waveEl = null) {
                const handComponent = handEl.components['xrextras-hand-model'];
                if (!handComponent || !handComponent.data.handData) return;

                const handData = handComponent.data.handData;
                if (!handData.landmarks || handData.landmarks.length < 21) return;

                // Get pinch point (midpoint between thumb and index tips)
                const thumbTip = handData.landmarks[4];
                const indexTip = handData.landmarks[8];
                
                if (!thumbTip || !indexTip) return;
                
                const pinchPoint = {
                    x: (thumbTip.x + indexTip.x) / 2,
                    y: (thumbTip.y + indexTip.y) / 2,
                    z: (thumbTip.z + indexTip.z) / 2
                };
                
                const targetWave = waveEl || (hand === 'left' ? this.leftWave : this.rightWave);
                if (targetWave) {
                    targetWave.setAttribute('position', `${pinchPoint.x} ${pinchPoint.y} ${pinchPoint.z}`);
                }
            }
        }

        // Initialize the scene after components are registered
        function initScene() {
            // Wait for DOM to be fully ready
            const waitForDOM = () => {
                const scene = document.querySelector('a-scene');
                const statusEl = document.getElementById('status');
                
                if (!scene || !statusEl) {
                    setTimeout(waitForDOM, 100);
                    return;
                }
                
                scene.addEventListener('loaded', function() {
                    console.log('Scene loaded');
                    
                    // Add pinch detector to scene
                    this.setAttribute('pinch-detector', '');
                    
                    // Update status safely
                    setTimeout(() => {
                        const status = document.getElementById('status');
                        if (status) {
                            status.textContent = 'Hand tracking ready! Pinch to create liquid waves!';
                        }
                    }, 2000);
                });

                // Handle XR errors
                document.addEventListener('xrerror', function(event) {
                    console.error('XR Error:', event.detail);
                    const status = document.getElementById('status');
                    if (status) {
                        status.textContent = 'XR Error: ' + event.detail.message;
                    }
                });

                // Handle permissions
                document.addEventListener('xrpermissionerror', function(event) {
                    console.error('XR Permission Error:', event.detail);
                    const status = document.getElementById('status');
                    if (status) {
                        status.textContent = 'Please allow camera access for hand tracking';
                    }
                });
            };
            
            waitForDOM();
        }

        // Call initScene after components are registered
        setTimeout(initScene, 500);
    }
</body>
</html>
      
